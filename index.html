<!DOCTYPE HTML>
<html lang="no-NO">
<head>
	<meta charset="UTF-8">
	<title>Tablefuck</title>
	<link rel="stylesheet" href="css/main.css">
	<link rel="stylesheet" href="css/jquery.handsontable.full.css">
</head>
<body>
	<h3>Tablefuck</h3>
	<div id="tableContainer">
		
	</div>
	<div style="border-bottom: 1px solid #ddd">&nbsp;</div>
		<div class="btn" id="saveBtn"><a href="#" data-id="save">Lagre tabell</a></div>
		<div class="btn" id="loadBtn"><a href="#" data-id="load">Hent tabell</a></div>
		<div class="btn" id="deleteBtn"><a href="#" data-id="deleteLog">Slett logg</a></div>
	</div>
	<div style="clear:both;">
		<p><a href="#" class="data" data-url="data1.js">Load data1</a></p>
		<p><a href="#" class="data" data-url="data2.js">Load data2</a></p>
	</div>
	<div id="log">
		
	</div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
	<script src="js/jquery.handsontable.full.js"></script>
	<script>
		$(document).ready(function() {
			var l = $("#log");
			function log(str) {
				l.append(str+"<br>");
			}
			log("init");

			//buttons (test)
			$(".btn a").on("click", function(e) {
				e.preventDefault();
				switch($(this).data("id")) {
					case "save":
						//getData();
						saveData();
						log("saving table...");
						break;
					case "load":
						log("load table...");
						break;
					case "deleteLog":
						l.html("");
						break;
				}
			});

			//load data
			var nestedObjects = [];
			$("a.data").on("click", function() {
				log("> "+$(this).data("url"));
				var url = "data/"+$(this).data("url");
				$.ajax({
	                url: url,
	                dataType: 'json',
	                type: 'GET',
	                cache: false,
	                success: function(data) { 	
	                	nestedObjects = data;
	                    openTable(nestedObjects);
	                },
	                error: function(j, e) {
	                    //error loading data
	                    log("error: "+j+" "+e);
	                }
	            });
			})

			function getColumns() {
				//l.html("");
				log("rows: "+nestedObjects.length);
				var arr = [];
				var colsCount = 0;
				if (nestedObjects.length > 0) {
					for (var i = 0; i < nestedObjects.length; i++) {
						/*
							- sjekke hvilken tr {} som har flest td
							- hvis en eller flere tr har +1 (colspan?) - men hvilen?

						*/

						var c2 = 0;
						for (var j in nestedObjects[i]) {
							c2++;
						}

						if (c2 > colsCount) {
							colsCount = c2;
						}
					}
					log("colsCount "+colsCount)
					for (var k = 0; k < colsCount; k++) {
						arr.push({data: "col"+(k+1)+".txt"})
					}
				}
				return arr;
			}

			var menuArr = {
				callback: function(key, options) {
					log("key > "+key);
					var a = getSelected();
					switch(key) {
						case "bold":
							setStyle("bold");
							break;
						case "red":
							setStyle("red");
							break;
						case "lineunder":
							setStyle("line-under");
							break;
						case "right":
							setStyle("right");
							break;
						case "left":
							setStyle("left");
							break;
						case "center":
							setStyle("center");
							break;
						case "background":
							setStyle("cellBg", true);
							break;
						case "background-css":
							setStyle("cellBg");
							break;
						case "turnOffMenu":
							$container.handsontable('updateSettings', {contextMenu: false});
							break;
					}
				},
				items: {
					"bold": {
						name: "Sett celle i bold"
						/*
						disabled: function () {
						  //if first row, disable this option
						  log("selected: "+($container.handsontable('getSelected')[0] === 0));
						}
						*/
					},
					"red": {
						name: "Sett celle rød"
					},
					"lineunder": {
						name: "Sett strek under"
					},
					"right": {
						name: "Sett høyrejustert"
					},
					"left": {
						name: "Sett venstrejustert"
					},
					"center": {
						name: "Sett sentrert"
					},
					"background": {
						name: "Sett bakgrunn"
					},
					"background-css": {
						name: "Sett bakgrunn (css)"
					},
					"hsep2": "---------",
					"turnOffMenu": {
						name: "Slå av meny"
					}
						
				}
				
			};

			//get td element(s)
			function getSelected() {
				//[startRow, startCol, endRow, endCol]
				var s = $container.handsontable('getSelected').toString();
				var a = s.split(",");
				var col = 1;
				var rows = 1;
				var obj = {};

				if (a[1] == a[3]) {
					//log("samme kolonne");
				} else {
					//log("flere kolonner. Ant: "+(Math.abs(a[1] - a[3])+1));
					col = (Math.abs(a[1] - a[3])+1);
				}

				if (a[0] == a[2]) {
					//log("enkel rekke");
				} else {
					//log("flere rekker. Ant: "+(Math.abs(a[0] - a[2])+1));
					rows = (Math.abs(a[0] - a[2])+1);
				}

				obj = {
					startrow: a[0],
					/*endrow: a[2],*/
					startcol: a[1],
					/*endcol: a[3],*/
					col: col,
					rows: rows
				}
				return obj;
			}

			function setStyle(styleclass, old = false) {
				var a = getSelected();
				for (var i = 0; i < a.col; i++) {
					for (var j = 0; j < a.rows; j++) {
						var row = j+parseInt(a.startrow);
						var col = i+parseInt(a.startcol);
						var t = $container.handsontable('getCell', row, col);
						if (old) {
							//t.style.background = "#ff33ff";
						} else {
							$(t).toggleClass(styleclass);
						}
						//log("---> old: "+old+" "+styleclass+" > "+t.className+" > "+t.cellIndex+" > "+t.parentNode);
					}
				}
			}

			function saveData() {
				log("--> cols "+$container.handsontable('countCols'));
				var cols = $container.handsontable('countCols');
				$container.find("table").each(function(i) {
					var $el = $(this);
					
					var arr = [];
					$el.find("tr").each(function(i) {
						var $tr = $(this);
						log("---- "+i);
						//col1: {txt: "Joan", class: "red"},
						var obj = {};
						$tr.find('td').each(function(k) {
							$td = $(this);
							log(i+" > "+$(this).text() + " > "+$(this).attr("class"));
							obj["col"+(k+1)] = {
								txt: $(this).text(),
								class: $(this).attr("class")
							}
						});
						arr.push(obj);
					})
					$container.handsontable('loadData', arr);
					log("---saved---- "+JSON.stringify(arr));
				})
			}

			function cssRenderer(instance, td, row, col, prop, value, cellProperties) {
				Handsontable.TextCell.renderer.apply(this, arguments);
				//log("instance: "+instance+" td: "+td+" r: "+row+" col: "+col+" p: "+prop+" v: "+value);
				var classArr = prop.toString().split(".");
				var d = $container.handsontable('getDataAtRowProp', row, classArr[0]+".class");
				$(td).toggleClass(d);
			}

			var $container = $("#tableContainer");
			function openTable(arr) {
				log("open table "+arr);
				$container.handsontable({
				  data: arr,
				  width: 600,
				  height: arr.length * 25,
				  /*startRows: 5,
				  startCols: 4,
				  colHeaders: true,*/
				  multiSelect: true,
				  fillHandle: false,
				  columns: getColumns()
				  /*[
				    {data: "col1.txt"},
				    {data: "col2.txt"},
				    {data: "col3.txt"},
				    {data: "col4.txt"}
				  ]*/,
				  cells: function (row, col, prop) {
	      			return { type: { renderer: cssRenderer } }
	      		  }, 
	      		  contextMenu: menuArr
	      		  /*,
				  minSpareRows: 1*/
				});
			}
			
		})
	</script>
</body>
</html>